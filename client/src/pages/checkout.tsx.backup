import { useState, useEffect, useCallback } from "react";
import { useCart } from "@/hooks/use-cart";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Checkbox } from "@/components/ui/checkbox";
import { useMutation, useQuery } from "@tanstack/react-query";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { useLocation } from "wouter";
import { ArrowLeft, Plus, Loader2, MapPin, CheckCircle2, ShoppingCart, MapPinned, CreditCard } from "lucide-react";
import { InputOTP, InputOTPGroup, InputOTPSlot } from "@/components/ui/input-otp";
import { BottomSheet } from "@/components/ui/bottom-sheet";
import { scrollToContext } from "@/lib/scroll-utils";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";

interface UserInfo {
  name: string;
  addressLine1: string;
  addressLine2: string;
  addressLine3: string;
  landmark: string;
  city: string;
  pincode: string;
}

const EMPTY_USER_INFO: UserInfo = {
  name: "",
  addressLine1: "",
  addressLine2: "",
  addressLine3: "",
  landmark: "",
  city: "",
  pincode: "",
};

export default function Checkout() {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const { cartItems, subtotal, clearCart, isLoading: isCartLoading } = useCart();
  
  // Accordion step tracking
  const [orderConfirmed, setOrderConfirmed] = useState(false);
  const [addressComplete, setAddressComplete] = useState(false);
  const [paymentReady, setPaymentReady] = useState(false);
  const [activeAccordionStep, setActiveAccordionStep] = useState<string>("step-1");
  
  // Old step tracking (for phone/OTP flow within Step 2)
  const [step, setStep] = useState<"phone" | "otp" | "details">("phone");
  const [phone, setPhone] = useState("");
  const [otp, setOtp] = useState("");
  const [userInfo, setUserInfo] = useState<UserInfo>(EMPTY_USER_INFO);
  const [user, setUser] = useState<any>(null);
  const [paymentMethod, setPaymentMethod] = useState("upi");
  const [selectedAddressId, setSelectedAddressId] = useState<string>("");
  const [showNewAddressForm, setShowNewAddressForm] = useState(false);
  const [makePreferred, setMakePreferred] = useState(false);
  const [shippingCharge, setShippingCharge] = useState(50); // Default shipping
  const [isCalculatingShipping, setIsCalculatingShipping] = useState(false);
  const [isPincodeValid, setIsPincodeValid] = useState(false);
  const [previousSelectedAddressId, setPreviousSelectedAddressId] = useState<string | null>(null);
  const [couponCode, setCouponCode] = useState("");
  const [appliedOffer, setAppliedOffer] = useState<any>(null);
  const [couponError, setCouponError] = useState("");
  const [isAddressSheetOpen, setIsAddressSheetOpen] = useState(false);

  // Load selected offer from cart if available
  useEffect(() => {
    const selectedOffer = queryClient.getQueryData<{ id: string; code: string } | null>([
      "checkout",
      "selectedOffer"
    ]);
    if (selectedOffer) {
      setAppliedOffer(selectedOffer);
    }
  }, []);

  // Calculate discount based on applied offer
  const calculateDiscount = () => {
    if (!appliedOffer) return 0;

    if (appliedOffer.discountType === 'percentage') {
      const discountAmount = (subtotal * (parseFloat(appliedOffer.discountValue) || 0)) / 100;
      const maxDiscount = appliedOffer.maxDiscount ? (parseFloat(appliedOffer.maxDiscount) || 0) : null;
      return maxDiscount && discountAmount > maxDiscount ? maxDiscount : discountAmount;
    } else {
      return parseFloat(appliedOffer.discountValue) || 0;
    }
  };

  const discount = calculateDiscount();

  // Function to validate pincode (6 digits)
  const validatePincode = useCallback((pincode: string): boolean => {
    return /^\d{6}$/.test(pincode);
  }, []);

  // Function to calculate shipping charges
  const calculateShipping = useCallback(async (pincode: string) => {
    if (!validatePincode(pincode)) {
      setShippingCharge(50); // Default fallback
      setIsPincodeValid(false);
      return;
    }

    if (cartItems.length === 0) {
      if (isCartLoading) {
        return;
      }

      setShippingCharge(50); // Default fallback
      setIsPincodeValid(false);
      return;
    }

    setIsCalculatingShipping(true);
    setIsPincodeValid(true);

    try {
      const response = await apiRequest("POST", "/api/shipping/calculate", {
        cartItems,
        pincode,
        orderValue: subtotal
      });
      const result = await response.json();
      setShippingCharge(result.shippingCharge);
    } catch (error) {
      console.error("Error calculating shipping:", error);
      setShippingCharge(50); // Fall back to default
    } finally {
      setIsCalculatingShipping(false);
    }
  }, [cartItems, isCartLoading, subtotal, validatePincode]);

  // Check if user is already logged in
  const { data: authData } = useQuery<{ authenticated: boolean; user?: any }>({
    queryKey: ["/api/auth/me"],
    retry: false,
  });

  // Get user addresses if logged in
  const { data: addresses } = useQuery<any[]>({
    queryKey: ["/api/auth/addresses"],
    enabled: authData?.authenticated || false,
    retry: false,
  });

  // Get last order's delivery address if logged in
  const { data: lastOrderAddress } = useQuery<any>({
    queryKey: ["/api/auth/addresses/last"],
    enabled: authData?.authenticated && addresses && addresses.length > 1,
    retry: false,
  });

  useEffect(() => {
    if (authData?.authenticated && authData.user) {
      setUser(authData.user);
      setStep("details");
      
      // Auto-populate name from user data if available and not already set
      if (authData.user.name && !userInfo.name) {
        setUserInfo(prev => ({
          ...prev,
          name: authData.user.name
        }));
      }

      if (!selectedAddressId && addresses && addresses.length > 0) {
        const preferred = addresses.find(addr => addr.isPreferred) ?? addresses[0];
        if (preferred) {
          setSelectedAddressId(preferred.id);
        }
      }
    }
  }, [authData, addresses, selectedAddressId, userInfo.name]);

  useEffect(() => {
    if (!addresses || addresses.length === 0 || showNewAddressForm) {
      return;
    }

    let effectiveSelectedId = selectedAddressId;

    if (!effectiveSelectedId) {
      const preferred = addresses.find(addr => addr.isPreferred) ?? addresses[0];
      if (preferred) {
        setSelectedAddressId(preferred.id);
        effectiveSelectedId = preferred.id;
      }
    }

    if (!effectiveSelectedId) {
      return;
    }

    const selectedAddress = addresses.find(addr => addr.id === effectiveSelectedId);

    if (!selectedAddress) {
      const fallback = addresses[0];
      if (fallback) {
        setSelectedAddressId(fallback.id);
      }
      return;
    }

    const addressParts = selectedAddress.address.split("\n");
    setUserInfo(prev => ({
      ...prev,
      addressLine1: addressParts[0] || "",
      addressLine2: addressParts[1] || "",
      addressLine3: addressParts[2] || "",
      landmark: "",
      city: selectedAddress.city,
      pincode: selectedAddress.pincode,
    }));

    const isValid = validatePincode(selectedAddress.pincode);
    setIsPincodeValid(isValid);

    if (isValid) {
      calculateShipping(selectedAddress.pincode);
    } else {
      setShippingCharge(50);
    }
  }, [addresses, calculateShipping, selectedAddressId, showNewAddressForm, validatePincode]);

  const sendOtpMutation = useMutation({
    mutationFn: async (): Promise<{ message: string }> => {
      const response = await apiRequest("POST", "/api/auth/send-otp", {
        phone,
        userType: "buyer",
      });
      return await response.json();
    },
    onSuccess: (result) => {
      setStep("otp");
      toast({
        title: "OTP Sent",
        description: result.message ?? "Please check your phone for the verification code",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to send OTP. Please try again.",
        variant: "destructive",
      });
    },
  });

  const verifyOtpMutation = useMutation({
    mutationFn: async (): Promise<{ message: string; user?: any; isNewUser?: boolean }> => {
      const response = await apiRequest("POST", "/api/auth/verify-otp", {
        phone,
        otp,
        userType: "buyer",
      });
      return await response.json();
    },
    onSuccess: (result) => {
      if (!result.user) {
        toast({
          title: "Verification Failed",
          description: result.message || "Unable to verify OTP. Please try again.",
          variant: "destructive",
        });
        return;
      }

      setUser(result.user);
      setStep("details");

      // Auto-populate name from user data if available
      if (result.user.name && !userInfo.name) {
        setUserInfo(prev => ({
          ...prev,
          name: result.user.name
        }));
      }

      // Update authentication cache to reflect logged-in state
      queryClient.setQueryData(["/api/auth/me"], {
        authenticated: true,
        user: result.user
      });

      // Invalidate queries to refresh user data
      queryClient.invalidateQueries({ queryKey: ["/api/auth/addresses"] });
      queryClient.invalidateQueries({ queryKey: ["/api/auth/orders"] });

      toast({
        title: "Phone Verified",
        description: result.message || "Please fill in your delivery details",
      });
    },
    onError: () => {
      toast({
        title: "Verification Failed",
        description: "Invalid or expired OTP. Please try again.",
        variant: "destructive",
      });
    },
  });

  const createAddressMutation = useMutation({
    mutationFn: async (addressData: any) => {
      const response = await apiRequest("POST", "/api/auth/addresses", addressData);
      return await response.json();
    },
    onSuccess: (newAddress: any) => {
      const addressLines = newAddress?.address?.split("\n") ?? [];

      setSelectedAddressId(newAddress?.id ?? "");
      setUserInfo(prev => ({
        ...prev,
        addressLine1: addressLines[0] ?? "",
        addressLine2: addressLines[1] ?? "",
        addressLine3: addressLines[2] ?? "",
        landmark: "",
        city: newAddress?.city ?? "",
        pincode: newAddress?.pincode ?? "",
      }));

      const isValid = newAddress?.pincode ? validatePincode(newAddress.pincode) : false;
      setIsPincodeValid(isValid);
      if (isValid) {
        calculateShipping(newAddress.pincode);
      } else {
        setShippingCharge(50);
      }

      setShowNewAddressForm(false);
      setPreviousSelectedAddressId(null);
      setMakePreferred(false);

      toast({
        title: "Address saved",
        description: "Your new address has been saved successfully",
      });

      // Scroll to continue/checkout button after address is saved
      setTimeout(() => scrollToContext("address-saved"), 300);

      queryClient.setQueryData(["/api/auth/addresses"], (existing: any[] | undefined) => {
        if (!existing) {
          return newAddress ? [newAddress] : existing;
        }

        const index = existing.findIndex(addr => addr.id === newAddress?.id);
        if (index !== -1) {
          const updated = [...existing];
          updated[index] = newAddress;
          return updated;
        }

        return newAddress ? [...existing, newAddress] : existing;
      });

      queryClient.invalidateQueries({ queryKey: ["/api/auth/addresses"] });
    },
  });

  const validateOfferMutation = useMutation({
    mutationFn: async (payload: { code: string; userId: string; cartValue: number }) => {
      const response = await apiRequest("POST", "/api/offers/validate", payload);
      const result = await response.json();
      return result;
    },
    onSuccess: (result: any) => {
      if (result.valid) {
        setAppliedOffer(result.offer);
        setCouponError("");
        setCouponCode("");
        queryClient.setQueryData(["checkout", "selectedOffer"], 
          { id: result.offer.id, code: result.offer.code });
        toast({
          title: "Coupon Applied!",
          description: `You saved with ${result.offer.code}`,
        });
      } else {
        setCouponError(result.message);
        toast({
          title: "Invalid Coupon",
          description: result.message,
          variant: "destructive",
        });
      }
    },
    onError: () => {
      setCouponError("Failed to validate coupon");
      toast({
        title: "Error",
        description: "Failed to validate coupon",
        variant: "destructive",
      });
    },
  });

  const placeOrderMutation = useMutation({
    mutationFn: async () => {
      const orderUserInfoSnapshot = {
        ...userInfo,
        ...(showNewAddressForm ? { makePreferred } : {}),
      };
      let addressIdToUse = selectedAddressId || null;

      // If user selected an existing address, save it if marked as preferred
      if (selectedAddressId && makePreferred) {
        await apiRequest("PUT", `/api/auth/addresses/${selectedAddressId}/preferred`, {});
      }

      // If user is adding a new address, create it first
      if (showNewAddressForm && authData?.authenticated) {
        const addressData = {
          name: "Delivery Address",
          address: [userInfo.addressLine1, userInfo.addressLine2, userInfo.addressLine3].filter(line => line.trim()).join('\n'),
          city: userInfo.city,
          pincode: userInfo.pincode,
          isPreferred: makePreferred,
        };
        const newAddress = await createAddressMutation.mutateAsync(addressData);
        addressIdToUse = newAddress?.id ?? addressIdToUse;
      }

      // For logged-in users with no saved addresses, automatically save the current address
      if (authData?.authenticated && (!addresses || addresses.length === 0) && !selectedAddressId && !showNewAddressForm) {
        const addressData = {
          name: "Primary Address",
          address: [userInfo.addressLine1, userInfo.addressLine2, userInfo.addressLine3].filter(line => line.trim()).join('\n'),
          city: userInfo.city,
          pincode: userInfo.pincode,
          isPreferred: true, // First address becomes preferred automatically
        };
        const newAddress = await createAddressMutation.mutateAsync(addressData);
        addressIdToUse = newAddress?.id ?? addressIdToUse;
      }

      // Check if we have an existing checkout intent to reuse the ID
      let checkoutIntentId: string | undefined;
      
      try {
        const existingIntentStr = sessionStorage.getItem('checkoutIntent');
        if (existingIntentStr) {
          const existingIntent = JSON.parse(existingIntentStr);
          
          // Compare cart items (by product ID and quantity)
          const currentCartSignature = cartItems.map(item => `${item.productId}:${item.quantity}`).sort().join(',');
          const existingCartSignature = existingIntent.cartItems?.map((item: any) => `${item.productId}:${item.quantity}`).sort().join(',');
          
          if (currentCartSignature === existingCartSignature && 
              existingIntent.total === (subtotal + shippingCharge - discount) &&
              existingIntent.offerCode === (appliedOffer?.code ?? null)) {
            // Cart hasn't changed, reuse the intent ID
            checkoutIntentId = existingIntent.checkoutIntentId;
            console.log('[Checkout] Reusing checkout intent ID:', checkoutIntentId);
          }
        }
      } catch (error) {
        console.error('[Checkout] Failed to parse existing intent:', error);
      }

      // Generate new intent ID if we don't have one to reuse
      if (!checkoutIntentId) {
        checkoutIntentId = `intent_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
        console.log('[Checkout] Created new checkout intent ID:', checkoutIntentId);
      }
      
      // ALWAYS save/update intent to backend (even when reusing ID)
      // This ensures address, user info, and other details stay current
      const checkoutIntent = {
        checkoutIntentId,
        userInfo: orderUserInfoSnapshot,
        paymentMethod,
        offerCode: appliedOffer?.code ?? null,
        selectedAddressId: addressIdToUse,
        cartItems, // Store cart items for display on payment page
        subtotal,
        discount,
        shippingCharge,
        total: subtotal + shippingCharge - discount,
      };
      
      // Save/update intent in backend (upsert operation)
      const intentResponse = await apiRequest("POST", "/api/orders/checkout-intent", checkoutIntent);
      const intentResult = await intentResponse.json();
      
      // Also update in sessionStorage
      sessionStorage.setItem('checkoutIntent', JSON.stringify(checkoutIntent));
      console.log('[Checkout] Saved checkout intent to backend:', checkoutIntentId);

      return {
        checkoutIntentId,
        orderUserInfo: orderUserInfoSnapshot,
      };
    },
    onSuccess: async ({ checkoutIntentId, orderUserInfo }) => {
      const isUpiPayment = paymentMethod === 'upi';

      // Clear selected offer from cache
      queryClient.setQueryData(["checkout", "selectedOffer"], null);
      
      // Redirect to payment page with intent ID
      // Order will be created when payment page loads
      if (isUpiPayment || paymentMethod === 'cashfree') {
        setLocation(`/payment?intentId=${checkoutIntentId}`);
      } else {
        // For non-UPI payments, we still need to create the order
        // This case is not implemented yet - would need separate flow
        toast({
          title: "Payment Method Not Supported",
          description: "Please select UPI payment method",
          variant: "destructive",
        });
      }
    },
    onError: (error: any) => {
      console.error('[Checkout] Place order failed:', error);
      toast({
        title: "Checkout Failed",
        description: "Unable to process your order. Please try again.",
        variant: "destructive",
      });
      // Scroll to top where error will be visible
      setTimeout(() => scrollToContext("checkout-error"), 300);
    },
  });

  // Debug validation states for Place Order button
  useEffect(() => {
    console.log('[Checkout] Place Order Button Validation States:', {
      step,
      hasName: !!userInfo.name,
      hasAddressLine1: !!userInfo.addressLine1,
      hasAddressLine2: !!userInfo.addressLine2,
      hasCity: !!userInfo.city,
      hasPincode: !!userInfo.pincode,
      isPincodeValid,
      isCalculatingShipping,
      isPlacingOrder: placeOrderMutation.isPending,
      buttonShouldBeEnabled: step === "details" && 
        userInfo.name && 
        userInfo.addressLine1 && 
        userInfo.addressLine2 && 
        userInfo.city && 
        userInfo.pincode && 
        isPincodeValid && 
        !isCalculatingShipping && 
        !placeOrderMutation.isPending,
      userInfo,
    });
  }, [step, userInfo, isPincodeValid, isCalculatingShipping, placeOrderMutation.isPending]);

  // Scroll to pincode input during shipping calculation
  useEffect(() => {
    if (isCalculatingShipping) {
      setTimeout(() => scrollToContext("pincode-checking"), 100);
    }
  }, [isCalculatingShipping]);

  // Scroll to OTP input during verification
  useEffect(() => {
    if (verifyOtpMutation.isPending) {
      setTimeout(() => scrollToContext("otp-verification"), 100);
    }
  }, [verifyOtpMutation.isPending]);

  // Scroll to payment status during order processing
  useEffect(() => {
    if (placeOrderMutation.isPending) {
      setTimeout(() => scrollToContext("payment-processing"), 100);
    }
  }, [placeOrderMutation.isPending]);

  const total = subtotal + shippingCharge - discount; // Add shipping and subtract discount

  // Handler for confirming order (Step 1)
  const handleConfirmOrder = () => {
    if (cartItems.length === 0) {
      toast({
        title: "Cart is empty",
        description: "Please add items to your cart before proceeding",
        variant: "destructive",
      });
      return;
    }
    
    setOrderConfirmed(true);
    setActiveAccordionStep("step-2");
    
    toast({
      title: "Order Confirmed",
      description: "Now please provide your delivery address",
    });
  };
  
  // Handler for completing address (Step 2)
  const handleProceedToPayment = () => {
    // Validate address
    if (!userInfo.name || !userInfo.addressLine1 || !userInfo.addressLine2 || !userInfo.city || !userInfo.pincode) {
      toast({
        title: "Incomplete Address",
        description: "Please fill in all required address fields",
        variant: "destructive",
      });
      return;
    }
    
    if (!isPincodeValid) {
      toast({
        title: "Invalid PIN Code",
        description: "Please enter a valid 6-digit PIN code",
        variant: "destructive",
      });
      return;
    }
    
    setAddressComplete(true);
    setActiveAccordionStep("step-3");
    
    toast({
      title: "Address Confirmed",
      description: "Now choose your payment method",
    });
  };

  if (!cartItems || cartItems.length === 0) {
    return (
      <div className="text-center py-12">
        <h2 className="text-2xl font-semibold text-gray-900 mb-2">No items in cart</h2>
        <p className="text-gray-600 mb-3 sm:mb-6">Add some products before checkout</p>
        <Button onClick={() => setLocation("/")} data-testid="button-back-to-products">
          Back to Products
        </Button>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto px-4 py-6">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <Button
          onClick={() => setLocation("/")}
          variant="ghost"
          className="-ml-2 text-gray-800 hover:bg-gray-100 hover:text-gray-900"
          data-testid="button-back-to-products"
        >
          <ArrowLeft className="mr-2 h-4 w-4" />
          Back
        </Button>
        <div>
          <h1 className="text-3xl font-semibold text-gray-900">Checkout</h1>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-3 sm:gap-6">
        <div className="lg:col-span-2 space-y-3 sm:space-y-6">
          {/* Phone Verification */}
          {step === "phone" && (
            <div className="bg-white rounded-lg shadow-sm p-4 sm:p-6">
              <h3 className="font-semibold text-gray-900 mb-2 sm:mb-4 flex items-center">
                <i className="fas fa-mobile-alt text-blue-600 mr-2"></i>
                Phone Verification
              </h3>
              <div className="space-y-4">
                <div>
                  <Label htmlFor="phone">Phone Number</Label>
                  <div className="flex mt-2">
                    <span className="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                      +91
                    </span>
                    <Input
                      id="phone"
                      type="tel"
                      placeholder="9876543210"
                      value={phone}
                      onChange={(e) => setPhone(e.target.value)}
                      className="rounded-l-none"
                      data-testid="input-phone"
                    />
                  </div>
                </div>
                <Button
                  onClick={() => sendOtpMutation.mutate()}
                  disabled={!phone || sendOtpMutation.isPending}
                  data-testid="button-send-otp"
                >
                  Send OTP
                </Button>
              </div>
            </div>
          )}

          {/* OTP Verification */}
          {step === "otp" && (
            <div className="bg-white rounded-lg shadow-sm p-4 sm:p-6">
              <h3 className="font-semibold text-gray-900 mb-2 sm:mb-4 flex items-center">
                <i className="fas fa-shield-alt text-green-600 mr-2"></i>
                Enter OTP
              </h3>
              <div className="space-y-4">
                <div>
                  <Label htmlFor="otp">6-Digit OTP</Label>
                  <div className="flex justify-center sm:justify-start mt-2">
                    <InputOTP 
                      maxLength={6} 
                      value={otp}
                      onChange={(value) => setOtp(value)}
                      data-testid="input-otp"
                    >
                      <InputOTPGroup>
                        <InputOTPSlot index={0} className="h-14 w-14 text-xl sm:h-12 sm:w-12 sm:text-lg" />
                        <InputOTPSlot index={1} className="h-14 w-14 text-xl sm:h-12 sm:w-12 sm:text-lg" />
                        <InputOTPSlot index={2} className="h-14 w-14 text-xl sm:h-12 sm:w-12 sm:text-lg" />
                        <InputOTPSlot index={3} className="h-14 w-14 text-xl sm:h-12 sm:w-12 sm:text-lg" />
                        <InputOTPSlot index={4} className="h-14 w-14 text-xl sm:h-12 sm:w-12 sm:text-lg" />
                        <InputOTPSlot index={5} className="h-14 w-14 text-xl sm:h-12 sm:w-12 sm:text-lg" />
                      </InputOTPGroup>
                    </InputOTP>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">Paste your OTP or type it digit by digit</p>
                </div>
                <div className="flex space-x-3">
                  <Button
                    onClick={() => verifyOtpMutation.mutate()}
                    disabled={!otp || verifyOtpMutation.isPending}
                    className="bg-green-600 hover:bg-green-700"
                    data-testid="button-verify-otp"
                  >
                    Verify OTP
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => sendOtpMutation.mutate()}
                    disabled={sendOtpMutation.isPending}
                    data-testid="button-resend-otp"
                  >
                    Resend OTP
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Delivery Information */}
          {step === "details" && (
            <>
              <div className="bg-white rounded-lg shadow-sm p-4 sm:p-6">
                <h3 className="font-semibold text-gray-900 mb-2 sm:mb-4 flex items-center">
                  <i className="fas fa-truck text-blue-600 mr-2"></i>
                  Delivery Information
                </h3>

                {/* User Name */}
                <div className="mb-3 sm:mb-6">
                  <Label htmlFor="name">Full Name</Label>
                  <Input
                    id="name"
                    type="text"
                    placeholder="John Doe"
                    value={userInfo.name}
                    onChange={(e) => setUserInfo({ ...userInfo, name: e.target.value })}
                    className="mt-2"
                    data-testid="input-name"
                  />
                </div>

                {/* Address Selection/Management */}
                {addresses && addresses.length > 0 && (
                  <>
                    {/* Preferred Address Card (shown above form) */}
                    {(() => {
                      const preferredAddress = addresses.find(addr => addr.isPreferred);
                      return preferredAddress && !showNewAddressForm ? (
                        <div className="mb-3 sm:mb-6">
                          <Label className="text-base font-medium">Preferred Address</Label>
                          <div
                            className={`mt-2 border rounded-lg p-4 cursor-pointer transition-colors ${
                              selectedAddressId === preferredAddress.id
                                ? 'border-blue-500 bg-blue-50'
                                : 'border-gray-200 hover:border-gray-300'
                            }`}
                            onClick={() => {
                              setShowNewAddressForm(false);
                              setSelectedAddressId(preferredAddress.id);
                            }}
                            data-testid={`preferred-address-${preferredAddress.id}`}
                          >
                            <div className="flex items-start justify-between">
                              <div className="flex items-start gap-3">
                                <input
                                  type="radio"
                                  name="addressSelection"
                                  checked={selectedAddressId === preferredAddress.id}
                                  onChange={() => {}}
                                  className="mt-1"
                                />
                                <div className="flex-1">
                                  <div className="flex items-center gap-2">
                                    <h4 className="font-medium">{preferredAddress.name}</h4>
                                    <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                      Preferred
                                    </span>
                                  </div>
                                  <p className="text-sm text-gray-600 mt-1">
                                    {preferredAddress.address}, {preferredAddress.city} - {preferredAddress.pincode}
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      ) : null;
                    })()}

                    {/* Option to use different address or add new */}
                    {!showNewAddressForm && (
                      <div className="space-y-3">
                        <Button
                          variant="outline"
                          onClick={() => {
                            setPreviousSelectedAddressId(selectedAddressId || null);
                            setSelectedAddressId("");
                            setShowNewAddressForm(true);
                            setMakePreferred(false);
                            setUserInfo(prev => ({
                              ...EMPTY_USER_INFO,
                              name: prev.name,
                            }));
                            setIsPincodeValid(false);
                            setShippingCharge(50);
                          }}
                          className="w-full"
                          data-testid="button-use-different-address"
                        >
                          <Plus className="w-4 h-4 mr-2" />
                          Use Different Address
                        </Button>
                        
                        {addresses.length > 1 && (
                          <>
                            {/* Desktop: Details Element */}
                            <details className="hidden md:block group">
                              <summary className="cursor-pointer text-sm text-blue-600 hover:text-blue-800">
                                Choose from other saved addresses
                              </summary>
                              <div className="mt-2 space-y-2">
                                {addresses.filter(addr => !addr.isPreferred).map((address) => (
                                  <div
                                    key={address.id}
                                    className={`border rounded-lg p-3 cursor-pointer transition-colors ${
                                      selectedAddressId === address.id
                                        ? 'border-blue-500 bg-blue-50'
                                        : 'border-gray-200 hover:border-gray-300'
                                    }`}
                                    onClick={() => {
                                      setShowNewAddressForm(false);
                                      setSelectedAddressId(address.id);
                                    }}
                                    data-testid={`address-option-${address.id}`}
                                  >
                                    <div className="flex items-start justify-between">
                                      <div className="flex items-start gap-3">
                                        <input
                                          type="radio"
                                          name="addressSelection"
                                          checked={selectedAddressId === address.id}
                                          onChange={() => {}}
                                          className="mt-1"
                                        />
                                        <div className="flex-1">
                                          <h4 className="font-medium text-sm">{address.name}</h4>
                                          <p className="text-xs text-gray-600 mt-1">
                                            {address.address}, {address.city} - {address.pincode}
                                          </p>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </details>

                            {/* Mobile: Bottom Sheet */}
                            <div className="md:hidden">
                              <Button
                                variant="outline"
                                onClick={() => setIsAddressSheetOpen(true)}
                                className="w-full"
                                data-testid="button-choose-saved-address"
                              >
                                <MapPin className="w-4 h-4 mr-2" />
                                Choose from saved addresses
                              </Button>

                              <BottomSheet
                                open={isAddressSheetOpen}
                                onOpenChange={setIsAddressSheetOpen}
                                title="Select Address"
                              >
                                <div className="space-y-3 pb-6">
                                  {addresses.filter(addr => !addr.isPreferred).map((address) => (
                                    <div
                                      key={address.id}
                                      className={`border rounded-lg p-4 cursor-pointer transition-all active:scale-98 ${
                                        selectedAddressId === address.id
                                          ? 'border-blue-500 bg-blue-50'
                                          : 'border-gray-200 active:bg-gray-50'
                                      }`}
                                      onClick={() => {
                                        setShowNewAddressForm(false);
                                        setSelectedAddressId(address.id);
                                        setIsAddressSheetOpen(false);
                                      }}
                                      data-testid={`address-option-mobile-${address.id}`}
                                    >
                                      <div className="flex items-start gap-3">
                                        <input
                                          type="radio"
                                          name="addressSelectionMobile"
                                          checked={selectedAddressId === address.id}
                                          onChange={() => {}}
                                          className="mt-1"
                                        />
                                        <div className="flex-1">
                                          <h4 className="font-medium text-base">{address.name}</h4>
                                          <p className="text-sm text-gray-600 mt-1">
                                            {address.address}, {address.city} - {address.pincode}
                                          </p>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </BottomSheet>
                            </div>
                          </>
                        )}
                      </div>
                    )}
                  </>
                )}

                {/* New Address Form */}
                {showNewAddressForm && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <Label className="text-base font-medium">Add New Address</Label>
                      {addresses && addresses.length > 0 && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => {
                            setShowNewAddressForm(false);
                            setMakePreferred(false);
                            if (previousSelectedAddressId) {
                              setSelectedAddressId(previousSelectedAddressId);
                              setPreviousSelectedAddressId(null);
                            }
                          }}
                          data-testid="button-cancel-new-address"
                        >
                          Cancel
                        </Button>
                      )}
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <Label htmlFor="addressLine1">Address Line 1 *</Label>
                        <Input
                          id="addressLine1"
                          type="text"
                          placeholder="House/Flat No, Building Name"
                          value={userInfo.addressLine1}
                          onChange={(e) => setUserInfo({ ...userInfo, addressLine1: e.target.value })}
                          className="mt-2"
                          data-testid="input-address-line1"
                        />
                      </div>
                      <div>
                        <Label htmlFor="addressLine2">Address Line 2 *</Label>
                        <Input
                          id="addressLine2"
                          type="text"
                          placeholder="Street Name, Area"
                          value={userInfo.addressLine2}
                          onChange={(e) => setUserInfo({ ...userInfo, addressLine2: e.target.value })}
                          className="mt-2"
                          data-testid="input-address-line2"
                        />
                      </div>
                      <div>
                        <Label htmlFor="addressLine3">Address Line 3</Label>
                        <Input
                          id="addressLine3"
                          type="text"
                          placeholder="Sector, Locality (Optional)"
                          value={userInfo.addressLine3}
                          onChange={(e) => setUserInfo({ ...userInfo, addressLine3: e.target.value })}
                          className="mt-2"
                          data-testid="input-address-line3"
                        />
                      </div>
                      <div>
                        <Label htmlFor="landmark">Nearest Landmark</Label>
                        <Input
                          id="landmark"
                          type="text"
                          placeholder="Near Mall, School, etc. (Optional)"
                          value={userInfo.landmark}
                          onChange={(e) => setUserInfo({ ...userInfo, landmark: e.target.value })}
                          className="mt-2"
                          data-testid="input-landmark"
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <Label htmlFor="city">City</Label>
                        <Input
                          id="city"
                          type="text"
                          placeholder="Mumbai"
                          value={userInfo.city}
                          onChange={(e) => setUserInfo({ ...userInfo, city: e.target.value })}
                          className="mt-2"
                          data-testid="input-city"
                        />
                      </div>
                      <div>
                        <Label htmlFor="pincode">PIN Code</Label>
                        <Input
                          id="pincode"
                          type="text"
                          placeholder="400001"
                          maxLength={6}
                          value={userInfo.pincode}
                          onChange={(e) => {
                            const newPincode = e.target.value;
                            setUserInfo({ ...userInfo, pincode: newPincode });
                            
                            // Validate and calculate shipping on every change
                            if (validatePincode(newPincode)) {
                              calculateShipping(newPincode);
                            } else {
                              setIsPincodeValid(false);
                              setShippingCharge(50); // Default fallback
                            }
                          }}
                          className={`mt-2 ${!validatePincode(userInfo.pincode) && userInfo.pincode ? 'border-red-500' : ''}`}
                          data-testid="input-pincode"
                        />
                        {userInfo.pincode && !validatePincode(userInfo.pincode) && (
                          <p className="text-red-500 text-sm mt-1">PIN code must be exactly 6 digits</p>
                        )}
                      </div>
                    </div>

                    {authData?.authenticated && (
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="makePreferredNew"
                          checked={makePreferred}
                          onCheckedChange={(checked) => setMakePreferred(checked as boolean)}
                        />
                        <Label htmlFor="makePreferredNew" className="text-sm">
                          Save this address and set as preferred
                        </Label>
                      </div>
                    )}
                  </div>
                )}

                {/* Show address form for users with no saved addresses */}
                {(!addresses || addresses.length === 0) && !showNewAddressForm && (
                  <div className="space-y-4">
                    <div className="space-y-4">
                      <div>
                        <Label htmlFor="addressLine1">Address Line 1 *</Label>
                        <Input
                          id="addressLine1"
                          type="text"
                          placeholder="House/Flat No, Building Name"
                          value={userInfo.addressLine1}
                          onChange={(e) => setUserInfo({ ...userInfo, addressLine1: e.target.value })}
                          className="mt-2"
                          data-testid="input-address-line1"
                        />
                      </div>
                      <div>
                        <Label htmlFor="addressLine2">Address Line 2 *</Label>
                        <Input
                          id="addressLine2"
                          type="text"
                          placeholder="Street Name, Area"
                          value={userInfo.addressLine2}
                          onChange={(e) => setUserInfo({ ...userInfo, addressLine2: e.target.value })}
                          className="mt-2"
                          data-testid="input-address-line2"
                        />
                      </div>
                      <div>
                        <Label htmlFor="addressLine3">Address Line 3</Label>
                        <Input
                          id="addressLine3"
                          type="text"
                          placeholder="Sector, Locality (Optional)"
                          value={userInfo.addressLine3}
                          onChange={(e) => setUserInfo({ ...userInfo, addressLine3: e.target.value })}
                          className="mt-2"
                          data-testid="input-address-line3"
                        />
                      </div>
                      <div>
                        <Label htmlFor="landmark">Nearest Landmark</Label>
                        <Input
                          id="landmark"
                          type="text"
                          placeholder="Near Mall, School, etc. (Optional)"
                          value={userInfo.landmark}
                          onChange={(e) => setUserInfo({ ...userInfo, landmark: e.target.value })}
                          className="mt-2"
                          data-testid="input-landmark"
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <Label htmlFor="city">City</Label>
                        <Input
                          id="city"
                          type="text"
                          placeholder="Mumbai"
                          value={userInfo.city}
                          onChange={(e) => setUserInfo({ ...userInfo, city: e.target.value })}
                          className="mt-2"
                          data-testid="input-city"
                        />
                      </div>
                      <div>
                        <Label htmlFor="pincode">PIN Code</Label>
                        <Input
                          id="pincode"
                          type="text"
                          placeholder="400001"
                          maxLength={6}
                          value={userInfo.pincode}
                          onChange={(e) => {
                            const newPincode = e.target.value;
                            setUserInfo({ ...userInfo, pincode: newPincode });
                            
                            // Validate and calculate shipping on every change
                            if (validatePincode(newPincode)) {
                              calculateShipping(newPincode);
                            } else {
                              setIsPincodeValid(false);
                              setShippingCharge(50); // Default fallback
                            }
                          }}
                          className={`mt-2 ${!validatePincode(userInfo.pincode) && userInfo.pincode ? 'border-red-500' : ''}`}
                          data-testid="input-pincode"
                        />
                        {userInfo.pincode && !validatePincode(userInfo.pincode) && (
                          <p className="text-red-500 text-sm mt-1">PIN code must be exactly 6 digits</p>
                        )}
                      </div>
                    </div>

                    {authData?.authenticated && (
                      <div className="bg-blue-50 p-3 rounded-lg">
                        <p className="text-sm text-blue-800">
                          ✓ This address will be saved automatically for future orders
                        </p>
                      </div>
                    )}
                  </div>
                )}
              </div>

            </>
          )}
        </div>

        {/* Order Summary */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-lg shadow-sm p-4 sm:p-6 sticky top-24">
            <h3 className="font-semibold text-gray-900 mb-2 sm:mb-4">Order Summary</h3>
            
            {/* Summary Totals */}
            <div className="space-y-2 text-sm mb-2 sm:mb-4">
              <div className="flex justify-between">
                <span className="text-gray-600">Subtotal</span>
                <span data-testid="text-order-subtotal">₹{(subtotal / 1.05).toFixed(2)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Tax (5%)</span>
                <span data-testid="text-order-tax">₹{(subtotal - (subtotal / 1.05)).toFixed(2)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Shipping</span>
                <span data-testid="text-order-shipping">
                  {isCalculatingShipping ? (
                    <span className="text-blue-600">Calculating...</span>
                  ) : (
                    `₹${shippingCharge.toFixed(2)}`
                  )}
                </span>
              </div>
              
              {discount > 0 && (
                <div className="flex justify-between text-green-600">
                  <span>Discount ({appliedOffer?.code})</span>
                  <span data-testid="text-order-discount">-₹{discount.toFixed(2)}</span>
                </div>
              )}
              
              <hr className="my-2" />
              <div className="flex justify-between font-semibold text-lg">
                <span>Total</span>
                <span data-testid="text-order-total">₹{total.toFixed(2)}</span>
              </div>
            </div>

            {/* Coupon Section */}
            <div className="mt-4 pt-4 border-t border-gray-200">
              <h3 className="text-sm font-medium text-gray-900 mb-3">Apply Coupon</h3>
              {!appliedOffer ? (
                <>
                  <div className="flex space-x-2">
                    <Input
                      type="text"
                      placeholder="Enter coupon code"
                      value={couponCode}
                      onChange={(e) => setCouponCode(e.target.value.toUpperCase())}
                      className={`flex-1 text-sm ${couponError ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : ''}`}
                      data-testid="input-coupon-code"
                    />
                    <Button
                      onClick={() => {
                        if (couponCode.trim() && user?.id) {
                          setCouponError("");
                          validateOfferMutation.mutate({
                            code: couponCode.trim(),
                            userId: user.id,
                            cartValue: subtotal
                          });
                        }
                      }}
                      disabled={!couponCode.trim() || validateOfferMutation.isPending || !user?.id}
                      size="sm"
                      data-testid="button-apply-coupon"
                    >
                      {validateOfferMutation.isPending ? "Applying..." : "Apply"}
                    </Button>
                  </div>
                  {couponError && (
                    <div className="mt-2 text-xs text-red-600" data-testid="coupon-error">
                      {couponError}
                    </div>
                  )}
                </>
              ) : (
                <div className="flex items-center justify-between bg-green-50 p-2 rounded">
                  <div className="text-xs text-green-600">
                    <i className="fas fa-check-circle mr-1"></i>
                    "{appliedOffer.code}" applied
                  </div>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => {
                      setAppliedOffer(null);
                      setCouponError("");
                      setCouponCode("");
                      queryClient.setQueryData(["checkout", "selectedOffer"], null);
                      toast({
                        title: "Coupon Removed",
                        description: "The coupon has been removed from your order",
                      });
                    }}
                    className="text-gray-500 hover:text-red-600 h-6 px-2 text-xs"
                    data-testid="button-remove-coupon"
                  >
                    Remove
                  </Button>
                </div>
              )}
            </div>

            <div className="space-y-3 mt-4 mb-3 sm:mb-6">
              <div className="text-xs text-gray-500 flex items-center">
                <i className="fas fa-shield-alt mr-1"></i>
                Secure checkout with 256-bit SSL encryption
              </div>
            </div>

            {step === "details" && (
              <Button
                id="continue-button"
                className="w-full bg-green-600 hover:bg-green-700"
                onClick={() => {
                  console.log('[Checkout] Place Order button clicked');
                  placeOrderMutation.mutate();
                }}
                disabled={
                  !userInfo.name || 
                  !userInfo.addressLine1 || 
                  !userInfo.addressLine2 || 
                  !userInfo.city || 
                  !userInfo.pincode || 
                  !isPincodeValid || 
                  isCalculatingShipping || 
                  placeOrderMutation.isPending
                }
                data-testid="button-place-order"
              >
                {isCalculatingShipping ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Proceed to Payment - ₹{total.toFixed(2)}
                  </>
                ) : (
                  <>
                    <i className="fas fa-lock mr-2"></i>
                    Proceed to Payment - ₹{total.toFixed(2)}
                  </>
                )}
              </Button>
            )}
          </div>
        </div>
      </div>
    </div>
    </div>
  );
}
